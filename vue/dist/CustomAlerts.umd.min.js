(function(e,t){"object"===typeof exports&&"object"===typeof module?module.exports=t(require("CoreHome"),require("MobileMessaging"),require("vue"),require("CorePluginsAdmin")):"function"===typeof define&&define.amd?define(["CoreHome","MobileMessaging",,"CorePluginsAdmin"],t):"object"===typeof exports?exports["CustomAlerts"]=t(require("CoreHome"),require("MobileMessaging"),require("vue"),require("CorePluginsAdmin")):e["CustomAlerts"]=t(e["CoreHome"],e["MobileMessaging"],e["Vue"],e["CorePluginsAdmin"])})("undefined"!==typeof self?self:this,(function(e,t,r,l){return function(e){var t={};function r(l){if(t[l])return t[l].exports;var o=t[l]={i:l,l:!1,exports:{}};return e[l].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,l){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:l})},r.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(r.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(l,o,function(t){return e[t]}.bind(null,o));return l},r.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="plugins/CustomAlerts/vue/dist/",r(r.s="fae3")}({"19dc":function(t,r){t.exports=e},"576f":function(e,r){e.exports=t},"77cd":function(e,t){},"8bbf":function(e,t){e.exports=r},"8e01":function(e,t){},a5a2:function(e,t){e.exports=l},fae3:function(e,t,r){"use strict";if(r.r(t),r.d(t,"ListAlerts",(function(){return M})),r.d(t,"EditAlert",(function(){return oe})),"undefined"!==typeof window){var l=window.document.currentScript,o=l&&l.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);o&&(r.p=o[1])}var n=r("8bbf"),a={key:0},i={colspan:"6"},c=Object(n["createElementVNode"])("br",null,null,-1),u=Object(n["createElementVNode"])("br",null,null,-1),s=Object(n["createElementVNode"])("br",null,null,-1),d={class:"name"},m={class:"site"},p={class:"period"},b={class:"reportName"},f={class:"edit"},O=["href","title"],j=Object(n["createElementVNode"])("span",{class:"icon-edit"},null,-1),h=[j],A={class:"delete"},v=["onClick","id","title"],V=Object(n["createElementVNode"])("span",{class:"icon-delete"},null,-1),g=[V];function y(e,t,r,l,o,j){var V,y=Object(n["resolveDirective"])("content-table");return Object(n["withDirectives"])((Object(n["openBlock"])(),Object(n["createElementBlock"])("table",null,[Object(n["createElementVNode"])("thead",null,[Object(n["createElementVNode"])("tr",null,[Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Name")),1),Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Website")),1),Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Period")),1),Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Report")),1),Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Edit")),1),Object(n["createElementVNode"])("th",null,Object(n["toDisplayString"])(e.translate("General_Delete")),1)])]),Object(n["createElementVNode"])("tbody",null,[null!==(V=e.alerts)&&void 0!==V&&V.length?Object(n["createCommentVNode"])("",!0):(Object(n["openBlock"])(),Object(n["createElementBlock"])("tr",a,[Object(n["createElementVNode"])("td",i,[c,Object(n["createTextVNode"])(" "+Object(n["toDisplayString"])(e.translate("CustomAlerts_NoAlertsDefined"))+" ",1),u,s])])),(Object(n["openBlock"])(!0),Object(n["createElementBlock"])(n["Fragment"],null,Object(n["renderList"])(e.alerts,(function(t){return Object(n["openBlock"])(),Object(n["createElementBlock"])("tr",{key:t.idalert},[Object(n["createElementVNode"])("td",d,Object(n["toDisplayString"])(t.name),1),Object(n["createElementVNode"])("td",m,Object(n["toDisplayString"])(t.siteName),1),Object(n["createElementVNode"])("td",p,Object(n["toDisplayString"])(e.lcfirst(t.period)),1),Object(n["createElementVNode"])("td",b,Object(n["toDisplayString"])(t.reportName||"-"),1),Object(n["createElementVNode"])("td",f,[Object(n["createElementVNode"])("a",{class:"table-action",href:e.linkTo({module:"CustomAlerts",action:"editAlert",idAlert:t.idalert}),title:e.translate("General_Edit")},h,8,O)]),Object(n["createElementVNode"])("td",A,[Object(n["createElementVNode"])("button",{class:"deleteAlert table-action",onClick:function(r){return e.deleteAlert(t.idalert)},id:t.idalert,title:e.translate("General_Delete")},g,8,v)])])})),128))])],512)),[[y]])}var N=r("19dc"),_=Object(n["defineComponent"])({props:{alerts:{type:Array,required:!0}},directives:{ContentTable:N["ContentTable"]},methods:{deleteAlert:function(e){N["Matomo"].helper.modalConfirm("#confirm",{yes:function(){N["AjaxHelper"].fetch({method:"CustomAlerts.deleteAlert",idAlert:e}).then((function(){N["Matomo"].helper.redirect()}))}})},lcfirst:function(e){return"".concat(e[0].toUpperCase()).concat(e.substr(1))},linkTo:function(e){return"?".concat(N["MatomoUrl"].stringify(Object.assign(Object.assign({},N["MatomoUrl"].urlParsed.value),e)))}}}),C=r("77cd"),E=r.n(C);_.render=y,"function"===typeof E.a&&E()(_);var M=_,S={id:"customAlertPeriodHelp",class:"inline-help-node"},k={key:0},D={key:1,class:"row"},x={class:"col s12"},R={class:"row"},w={class:"col s12"},P={class:"row conditionAndValue"},T={class:"col s12 m6"},B={class:"col s12 m6"},U={class:"ui-autocomplete-input",ref:"reportValue"},q={class:"row conditionAndValue"},L={class:"col s12 m6"},I={class:"col s12 m6"},G=["innerHTML"];function F(e,t,r,l,o,a){var i,c,u=Object(n["resolveComponent"])("Field"),s=Object(n["resolveComponent"])("SelectPhoneNumbers"),d=Object(n["resolveComponent"])("Alert"),m=Object(n["resolveComponent"])("ActivityIndicator"),p=Object(n["resolveComponent"])("SaveButton"),b=Object(n["resolveDirective"])("form");return Object(n["withDirectives"])((Object(n["openBlock"])(),Object(n["createElementBlock"])("div",null,[Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"text",name:"alertName",modelValue:e.actualAlert.name,"onUpdate:modelValue":t[0]||(t[0]=function(t){return e.actualAlert.name=t}),maxlength:100,title:e.translate("CustomAlerts_AlertName")},null,8,["modelValue","title"])]),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"site",name:"idSite","model-value":null===(i=e.actualAlert.id_sites)||void 0===i?void 0:i[0],"onUpdate:modelValue":t[1]||(t[1]=function(t){e.actualAlert.id_sites[0]=t.id,e.changeReport()}),title:e.translate("General_Website"),introduction:e.translate("CustomAlerts_ApplyTo")},null,8,["model-value","title","introduction"])]),Object(n["createElementVNode"])("div",S,[Object(n["createTextVNode"])(Object(n["toDisplayString"])(e.translate("CustomAlerts_YouCanChoosePeriodFrom"))+": ",1),Object(n["createElementVNode"])("ul",null,[Object(n["createElementVNode"])("li",null,"&bull; "+Object(n["toDisplayString"])(e.translate("CustomAlerts_PeriodDayDescription")),1),Object(n["createElementVNode"])("li",null,"&bull; "+Object(n["toDisplayString"])(e.translate("CustomAlerts_PeriodWeekDescription")),1),Object(n["createElementVNode"])("li",null,"&bull; "+Object(n["toDisplayString"])(e.translate("CustomAlerts_PeriodMonthDescription")),1)])]),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"select",name:"period","inline-help":"#customAlertPeriodHelp","model-value":e.actualAlert.period,"onUpdate:modelValue":t[2]||(t[2]=function(t){e.actualAlert.period=t,e.changeReport()}),title:e.translate("General_Period"),options:e.periodOptions},null,8,["model-value","title","options"])]),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"checkbox",name:"report_email_me",modelValue:e.actualAlert.email_me,"onUpdate:modelValue":t[3]||(t[3]=function(t){return e.actualAlert.email_me=t}),introduction:e.translate("ScheduledReports_SendReportTo"),title:"".concat(e.translate("ScheduledReports_SentToMe")," (").concat(e.currentUserEmail,")")},null,8,["modelValue","introduction","title"])]),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"textarea",modelValue:e.actualAlert.additional_emails,"onUpdate:modelValue":t[4]||(t[4]=function(t){return e.actualAlert.additional_emails=t}),"var-type":"array",title:e.translate("ScheduledReports_AlsoSendReportToTheseEmails")},null,8,["modelValue","title"])]),e.supportsSMS?(Object(n["openBlock"])(),Object(n["createElementBlock"])("span",k,[Object(n["createVNode"])(s,{"phone-numbers":e.phoneNumbers,modelValue:e.actualAlert.phone_numbers,"onUpdate:modelValue":t[5]||(t[5]=function(t){return e.actualAlert.phone_numbers=t})},null,8,["phone-numbers","modelValue"])])):(Object(n["openBlock"])(),Object(n["createElementBlock"])("div",D,[Object(n["createElementVNode"])("div",x,[Object(n["createVNode"])(d,null,{default:Object(n["withCtx"])((function(){return[Object(n["createElementVNode"])("strong",null,Object(n["toDisplayString"])(e.translate("MobileMessaging_PhoneNumbers")),1),Object(n["createTextVNode"])(": "+Object(n["toDisplayString"])(e.mobileMessagingNotActivated),1)]})),_:1})])])),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"expandable-select",name:"report","model-value":e.actualAlert.report,"onUpdate:modelValue":t[6]||(t[6]=function(t){e.actualAlert.report=t,e.changeReport()}),options:e.reportOptions,title:"".concat(e.translate("CustomAlerts_ThisAppliesTo"),": ").concat(e.actualReportMetadata.name),introduction:e.translate("CustomAlerts_AlertCondition")},null,8,["model-value","options","title","introduction"])]),Object(n["withDirectives"])(Object(n["createElementVNode"])("div",R,[Object(n["createElementVNode"])("div",w,[Object(n["createVNode"])(m,{loading:e.isLoadingReport},null,8,["loading"])])],512),[[n["vShow"],e.isLoadingReport]]),Object(n["withDirectives"])(Object(n["createElementVNode"])("div",P,[Object(n["createElementVNode"])("div",T,[Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"select",name:"reportCondition",modelValue:e.actualAlert.report_condition,"onUpdate:modelValue":t[7]||(t[7]=function(t){return e.actualAlert.report_condition=t}),"full-width":!0,title:e.reportConditionTitle,options:e.alertGroupConditions},null,8,["modelValue","title","options"])])]),Object(n["createElementVNode"])("div",B,[Object(n["createElementVNode"])("div",U,[Object(n["withDirectives"])(Object(n["createVNode"])(u,{uicontrol:"text",role:"textbox",name:"reportValue",modelValue:e.actualAlert.report_matched,"onUpdate:modelValue":t[8]||(t[8]=function(t){return e.actualAlert.report_matched=t}),"full-width":!0,autocomplete:!1,maxlength:255,title:e.translate("General_Value")},null,8,["modelValue","title"]),[[n["vShow"],"matches_any"!==e.actualAlert.report_condition]])],512)])],512),[[n["vShow"],e.hasReportDimension]]),Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"select",name:"metric","model-value":e.actualAlert.metric,"onUpdate:modelValue":t[9]||(t[9]=function(t){return e.actualAlert.metric=t}),options:e.metricOptions,introduction:e.translate("CustomAlerts_AlertMeWhen")},null,8,["model-value","options","introduction"])]),Object(n["createElementVNode"])("div",q,[Object(n["createElementVNode"])("div",L,[Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"select",name:"metricCondition","model-value":e.actualAlert.metricCondition,"onUpdate:modelValue":t[10]||(t[10]=function(t){return e.actualAlert.metric_condition=t}),"full-width":!0,options:e.metricConditionOptions},null,8,["model-value","options"])])]),Object(n["createElementVNode"])("div",I,[Object(n["createElementVNode"])("div",null,[Object(n["createVNode"])(u,{uicontrol:"text",name:"metricValue",class:Object(n["normalizeClass"])({invalid:e.isMetricValueInvalid}),modelValue:e.actualAlert.metric_matched,"onUpdate:modelValue":t[11]||(t[11]=function(t){return e.actualAlert.metric_matched=t}),title:"<span>".concat(e.metricDescription,"</span>"),"full-width":!0},null,8,["class","modelValue","title"])])])]),(Object(n["openBlock"])(!0),Object(n["createElementBlock"])(n["Fragment"],null,Object(n["renderList"])(e.comparablesDates,(function(t,r){return Object(n["openBlock"])(),Object(n["createElementBlock"])("div",{key:t},[Object(n["withDirectives"])(Object(n["createVNode"])(u,{uicontrol:"select",name:"compared_to",modelValue:e.comparedTo[t],"onUpdate:modelValue":function(r){return e.comparedTo[t]=r},disabled:r.length<=1,options:r,introduction:e.translate("CustomAlerts_ComparedToThe")},null,8,["modelValue","onUpdate:modelValue","disabled","options","introduction"]),[[n["vShow"],t===e.actualAlert.period&&e.isComparable]])])})),128)),null!==(c=e.actualAlert)&&void 0!==c&&c.idalert?(Object(n["openBlock"])(),Object(n["createBlock"])(p,{key:2,onClick:t[12]||(t[12]=function(t){return e.updateAlert(e.actualAlert.idalert)}),saving:e.isLoading},null,8,["saving"])):(Object(n["openBlock"])(),Object(n["createBlock"])(p,{key:3,onClick:t[13]||(t[13]=function(t){return e.createAlert()}),saving:e.isLoading},null,8,["saving"])),Object(n["createElementVNode"])("div",{class:"entityCancel",innerHTML:e.$sanitize(e.cancelLink)},null,8,G)],512)),[[b]])}var H=r("a5a2"),W=r("576f");function $(e,t){return Q(e)||K(e,t)||J(e,t)||z()}function z(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function J(e,t){if(e){if("string"===typeof e)return Y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Y(e,t):void 0}}function Y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,l=new Array(t);r<t;r++)l[r]=e[r];return l}function K(e,t){var r=null==e?null:"undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var l,o,n=[],a=!0,i=!1;try{for(r=r.call(e);!(a=(l=r.next()).done);a=!0)if(n.push(l.value),t&&n.length===t)break}catch(c){i=!0,o=c}finally{try{a||null==r["return"]||r["return"]()}finally{if(i)throw o}}return n}}function Q(e){if(Array.isArray(e))return e}function X(e){return"MultiSites_getOne"===e||"MultiSites_getAll"===e}var Z=window,ee=Z.$,te=Object(n["defineComponent"])({props:{alert:Object,currentSite:{type:Object,required:!0},periodOptions:{type:Array,required:!0},currentUserEmail:{type:String,required:!0},supportsSMS:Boolean,phoneNumbers:{type:[Array,Object],required:!0},reportMetadata:Object,alertGroupConditions:{type:Array,required:!0},metricConditionOptions:{type:Array,required:!0},comparablesDates:{type:Object,required:!0}},components:{Field:H["Field"],Alert:N["Alert"],ActivityIndicator:N["ActivityIndicator"],SaveButton:H["SaveButton"],SelectPhoneNumbers:W["SelectPhoneNumbers"]},directives:{Form:H["Form"]},data:function(){var e={};return this.alert&&(e[this.alert.period]=this.alert.compared_to),{isLoading:!1,isLoadingReport:!1,showReportConditionField:!1,reportOptions:[],actualReportMetadata:null,reportValuesAutoComplete:null,actualAlert:this.alert?Object.assign({},this.alert):{},comparedTo:e}},watch:{actualReportMetadata:function(){var e,t=null===(e=this.actualReportMetadata)||void 0===e?void 0:e.metrics;if(t&&(!this.actualAlert.metric||!t[this.actualAlert.metric])){var r=Object.keys(t),l=$(r,1);this.actualAlert.metric=l[0]}},isMetricValueInvalid:function(e){if(e){var t=N["NotificationsStore"].show({message:Object(N["translate"])("CustomAlerts_InvalidMetricValue"),id:"CustomAlertsMetricValueError",context:"error",type:"toast"});N["NotificationsStore"].scrollToNotification(t)}}},created:function(){var e=this;setTimeout((function(){ee(e.$refs.reportValue).find("input").autocomplete({source:e.getValuesForReportAndMetric.bind(e),minLength:1,delay:300})}),1e3)},methods:{renderForm:function(e){var t=this,r=[];this.actualReportMetadata=null,e.forEach((function(e){var l=e.uniqueId;X(l)||(t.actualAlert.report||(t.actualAlert.report=l),r.push({key:l,value:e.name,group:e.category}),l===t.actualAlert.report&&(t.actualReportMetadata=e))})),this.reportOptions=r},sendApiRequest:function(e,t){var r=this;this.isLoading=!0;var l=this.actualAlert.period;N["AjaxHelper"].post({period:l,method:e},t).then((function(){N["Matomo"].helper.redirect({module:"CustomAlerts",action:"index"})})).finally((function(){r.isLoading=!1}))},getValuesForReportAndMetric:function(e,t){var r=this,l=this.actualAlert.metric;function o(r){var o=new RegExp(ee.ui.autocomplete.escapeRegex(e.term),"i");t(ee.grep(r,(function(e){return!!e&&o.test(e.label||e.value||e[l]||e)})))}if(this.reportValuesAutoComplete)o(this.reportValuesAutoComplete);else{this.reportValuesAutoComplete=[];var n=this.actualReportMetadata;if(n){var a=n.module,i=n.action;l&&a&&i||o(this.reportValuesAutoComplete),N["AjaxHelper"].fetch({method:"API.getProcessedReport",date:"yesterday",period:"month",disable_queued_filters:1,flat:1,filter_limit:-1,showColumns:l,language:"en",apiModule:a,apiAction:i,idSite:this.actualAlert.id_sites[0],format:"JSON"}).then((function(e){null!==e&&void 0!==e&&e.reportData?(r.reportValuesAutoComplete=e.reportData,o(e.reportData)):o([])})).catch((function(){o([])}))}}},changeReport:function(){var e=this;this.isLoadingReport=!0,this.reportValuesAutoComplete=null,N["AjaxHelper"].fetch({method:"API.getReportMetadata",date:N["Matomo"].currentDateString,period:this.actualAlert.period,idSites:this.actualAlert.id_sites,filter_limit:"-1"}).then((function(t){e.renderForm(t)})).finally((function(){e.isLoadingReport=!1}))},createAlert:function(){return!this.isMetricValueInvalid&&(this.sendApiRequest("CustomAlerts.addAlert",this.apiParameters),!0)},updateAlert:function(){return!this.isMetricValueInvalid&&(this.sendApiRequest("CustomAlerts.editAlert",this.apiParameters),!0)}},computed:{apiParameters:function(){return{idAlert:this.actualAlert.idalert,format:"json",name:this.actualAlert.name,metric:this.actualAlert.metric,metricCondition:this.actualAlert.metric_condition,metricValue:this.actualAlert.metric_matched,emailMe:this.actualAlert.email_me?1:0,additionalEmails:this.actualAlert.additional_emails||[""],phoneNumbers:this.actualAlert.phone_numbers||[""],reportUniqueId:this.actualAlert.report,reportCondition:this.actualAlert.report_condition,reportValue:this.actualAlert.report_matched,idSites:this.actualAlert.id_sites,comparedTo:this.actualAlert.compared_to}},isMetricValueInvalid:function(){return!ee.isNumeric(this.actualAlert.metric_matched)},mobileMessagingNotActivated:function(){var e="?".concat(N["MatomoUrl"].stringify(Object.assign(Object.assign({},N["MatomoUrl"].urlParsed.value),{},{module:"CorePluginsAdmin",action:"plugins",updated:null})));return Object(N["translate"])("CustomAlerts_MobileMessagingPluginNotActivated",'<a href="'.concat(e,'#MobileMessaging">'),"</a>")},cancelLink:function(){var e="?".concat(N["MatomoUrl"].stringify(Object.assign(Object.assign({},N["MatomoUrl"].urlParsed.value),{},{module:"CustomAlerts",action:"index"})));return Object(N["translate"])("General_OrCancel",'<a class="entityCancelLink" href="'.concat(e,'">'),"</a>")},metricOptions:function(){var e;return Object.entries((null===(e=this.actualReportMetadata)||void 0===e?void 0:e.metrics)||{}).map((function(e){var t=$(e,2),r=t[0],l=t[1];return{key:r,value:l}}))},hasReportDimension:function(){var e;return!(null===(e=this.actualReportMetadata)||void 0===e||!e.dimension)},reportConditionTitle:function(){var e,t=null===(e=this.actualReportMetadata)||void 0===e?void 0:e.dimension;return"".concat(Object(N["translate"])("CustomAlerts_When")," <span>").concat(t,"</span>")},isComparable:function(){var e=this.actualAlert.metric_condition;return e&&-1!==e.indexOf("_more_than")},metricDescription:function(){var e=this.actualAlert.metric_condition,t=this.actualAlert.metric,r=e&&0===e.indexOf("percentage_"),l=t&&-1!==t.indexOf("_rate"),o=t&&-1!==t.indexOf("_time_");return r||l?"%":o?"s":Object(N["translate"])("General_Value")}}}),re=r("8e01"),le=r.n(re);te.render=F,"function"===typeof le.a&&le()(te);var oe=te;
/*!
 * Matomo - free/libre analytics platform
 *
 * @link https://matomo.org
 * @license http://www.gnu.org/licenses/gpl-3.0.html GPL v3 or later
 */}})}));
//# sourceMappingURL=CustomAlerts.umd.min.js.map